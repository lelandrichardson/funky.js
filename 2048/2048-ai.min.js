var realValue=function(a){return a===0?0:Math.log(a)/Math.log(2)};var vectors={0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}};var monotonicity=function(g){if(!g||g.length<2){return true}var e=g[0],d=firstWhere(op["!=="](e),g),c=d-e>0,f;if(isUndefined(d)){return 0}return reduce(function(b,a){f=e;e=a;return b+(c?realValue(a)-f:f-realValue(a))},0,g)};extend(Game.prototype,{weight_smooth:0.1,weight_monotonicity:1,weight_empty:2.7,weight_max:1,evaluate:function(){return this.smooth2()*this.weight_smooth+this.mono2()*this.weight_monotonicity+Math.log(this.emptyCells())*this.weight_empty+realValue(this.maxValue())*this.weight_max},clone:function(){return new Game(this.cells.slice(0))},eachPosition:function(c){var a,d,b;for(a=1;a<=size;a++){for(d=1;d<=size;d++){b=indexFor(a,d);c.call(this,this.cells[b],b,a,d)}}},smoothness:function(){var a=this;return this.fold(function(e,g,c){if(g>0){var f=realValue(g),d=positionFor(c),b=[a.valueAt(d.x,d.y+1),a.valueAt(d.x+1,d.y)];return e-compose(sum,map(function(h){return Math.abs(f-realValue(h))}),filter(truthy))(b)}return e},0)},smooth2:function(){var a=0;this.eachPosition(function(f,d,b,j){for(var h=1;h<=2;h++){var c=vectors[h];var e=this.findFarthestPosition({x:b,y:j},c).next;var g=this.valueAt(e.x,e.y);if(g){a-=Math.abs(f-realValue(g))}}});return a},findFarthestPosition:function(a,b){var d,c=a;do{d=c;c={x:d.x+b.x,y:d.y+b.y}}while(indexFor(c.x,c.y)!==-1&&this.valueAt(c.x,c.y)===0);return{farthest:d,next:c}},mono2:function(){var c=[0,0,0,0];var f;var e;var b;var d;for(var a=1;a<=4;a++){f=1;e=f+1;while(e<=4){while(e<=4&&!this.valueAt(a,e)){e++}if(e>4){e--}d=realValue(this.valueAt(a,f));b=realValue(this.valueAt(a,e));if(d>b){c[0]+=b-d}else{if(b>d){c[1]+=d-b}}f=e;e++}}for(var g=1;g<=4;g++){f=1;e=f+1;while(e<=4){while(e<=4&&!this.valueAt(e,g)){e++}if(e>4){e--}d=realValue(this.valueAt(f,g));b=realValue(this.valueAt(e,g));if(d>b){c[2]+=b-d}else{if(b>d){c[3]+=d-b}}f=e;e++}}return Math.max(c[0],c[1])+Math.max(c[2],c[3])},islands:function(){var b=this;var e,a,g;var c=new Array(size*size);var f=function(k,h,m,l){if(h>=1&&h<=4&&m>=1&&m<=4&&b.cells[k]===l&&!c[k]){c[k]=true;for(e in [0,1,2,3]){var j=vectors[e];f(indexFor(h+j.x,m+j.y),h+j.x,m+j.y,l)}}};var d=0;this.eachPosition(function(j,h){if(j){c[h]=false}});this.eachPosition(function(j,h){if(j&&!c[h]){d++;f(h,a,g,j)}});return d},emptyCells:function(){return countWhere(falsy,this.cells)},maxValue:function(){return max(this.cells)}});extend(GameManager.prototype,{solve:function(){var a=this;if(a.solveTimeout){clearTimeout(a.solveTimeout);a.solveTimeout=null;return}function b(){if(a.game.isGameOver()||a.game.isGameWon()){a.solveTimeout=null;return}var d=new Solver(a.game);var c=d.iterativeDeep();a.move(c.move);a.solveTimeout=setTimeout(b,0)}a.solveTimeout=setTimeout(b,0)}});function Solver(a,b){this.game=a;this.isOpponent=!!b}extend(Solver.prototype,{searchTime:100,iterativeDeep:function(){var d=(new Date()).getTime();var c=0;var b;do{var a=this.search(c,-10000,10000,0,0);if(a.move==-1){break}else{b=a}c++}while((new Date).getTime()-d<this.searchTime);return b},search2:function(w,d,s,f,e){var j=-1,g,h,l,u;if(!this.isOpponent){g=d;for(var t in directions){l=this.game.move(t);if(l===null){continue}f++;if(l.isGameWon()){return{move:t,score:10000,positions:f,cutoffs:e}}u=new Solver(l,true);if(w===0){h={move:t,score:l.evaluate()}}else{h=u.search(w-1,g,s,f,e);if(h.score>9900){h.score--}f=h.positions;e=h.cutoffs}if(h.score>g){g=h.score;j=t}if(g>s){e++;return{move:j,score:s,positions:f,cutoffs:e}}}}else{g=s;var a=this.game.availableCells();var o={2:[],4:[]};for(var m=2;m<=4;m+=2){for(var n=0;n<a.length;n++){p=a[n];this.game.cells[p]=m;o[m].push({i:p,val:m,score:-this.game.smooth2()+this.game.islands()});this.game.cells[p]=0}}var q=flatten(o[2],o[4]);var v=max(pluck("score",q));var b=where(function(c){return c.score===v},q);for(var p=0;p<b.length;p++){var r=b[p];l=this.game.clone();l.cells[r.i]=r.val;f++;u=new Solver(l,false);h=u.search(w,d,g,f,e);f=h.positions;e=h.cutoffs;if(h.score<g){g=h.score}if(g<d){e++;return{move:null,score:d,positions:f,cutoffs:e}}}}return{move:j,score:g,positions:f,cutoffs:e}},search:function(w,d,s,f,e){var j=-1,g,h,l,u;if(!this.isOpponent){g=d;for(var t in directions){l=this.game.move(t);if(l===null){continue}f++;if(l.isGameWon()){return{move:t,score:10000,positions:f,cutoffs:e}}u=new Solver(l,true);if(w===0){h={move:t,score:l.evaluate()}}else{h=u.search(w-1,g,s,f,e);if(h.score>9900){h.score--}f=h.positions;e=h.cutoffs}if(h.score>g){g=h.score;j=t}if(g>s){e++;return{move:j,score:s,positions:f,cutoffs:e}}}}else{g=s;var a=this.game.availableCells();var o={2:[],4:[]};for(var m=2;m<=4;m+=2){for(var n=0;n<a.length;n++){p=a[n];this.game.cells[p]=m;o[m].push({i:p,val:m,score:-this.game.smooth2()+this.game.islands()});this.game.cells[p]=0}}var q=flatten(o[2],o[4]);var v=max(pluck("score",q));var b=where(function(c){return c.score===v},q);for(var p=0;p<b.length;p++){var r=b[p];l=this.game.clone();l.cells[r.i]=r.val;f++;u=new Solver(l,false);h=u.search(w,d,g,f,e);f=h.positions;e=h.cutoffs;if(h.score<g){g=h.score}if(g<d){e++;return{move:null,score:d,positions:f,cutoffs:e}}}}return{move:j,score:g,positions:f,cutoffs:e}}});